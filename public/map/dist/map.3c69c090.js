let t;var e,n={};e=function(t){function e(t,e,n){this.obj=t,this.left=null,this.right=null,this.parent=n,this.dimension=e}function n(t){this.content=[],this.scoreFunction=t}n.prototype={push:function(t){this.content.push(t),this.bubbleUp(this.content.length-1)},pop:function(){var t=this.content[0],e=this.content.pop();return this.content.length>0&&(this.content[0]=e,this.sinkDown(0)),t},peek:function(){return this.content[0]},remove:function(t){for(var e=this.content.length,n=0;n<e;n++)if(this.content[n]==t){var o=this.content.pop();n!=e-1&&(this.content[n]=o,this.scoreFunction(o)<this.scoreFunction(t)?this.bubbleUp(n):this.sinkDown(n));return}throw Error("Node not found.")},size:function(){return this.content.length},bubbleUp:function(t){for(var e=this.content[t];t>0;){var n=Math.floor((t+1)/2)-1,o=this.content[n];if(this.scoreFunction(e)<this.scoreFunction(o))this.content[n]=e,this.content[t]=o,t=n;else break}},sinkDown:function(t){for(var e=this.content.length,n=this.content[t],o=this.scoreFunction(n);;){var i=(t+1)*2,l=i-1,r=null;if(l<e){var a=this.content[l],c=this.scoreFunction(a);c<o&&(r=l)}if(i<e){var u=this.content[i];this.scoreFunction(u)<(null==r?o:c)&&(r=i)}if(null!=r)this.content[t]=this.content[r],this.content[r]=n,t=r;else break}}},t.kdTree=function(t,o,i){var l=this;Array.isArray(t)?this.root=function t(n,o,l){var r,a,c=o%i.length;return 0===n.length?null:1===n.length?new e(n[0],c,l):(n.sort(function(t,e){return t[i[c]]-e[i[c]]}),r=Math.floor(n.length/2),(a=new e(n[r],c,l)).left=t(n.slice(0,r),o+1,a),a.right=t(n.slice(r+1),o+1,a),a)}(t,0,null):(l.root=t,function t(e){e.left&&(e.left.parent=e,t(e.left)),e.right&&(e.right.parent=e,t(e.right))}(l.root)),this.toJSON=function(t){t||(t=this.root);var n=new e(t.obj,t.dimension,null);return t.left&&(n.left=l.toJSON(t.left)),t.right&&(n.right=l.toJSON(t.right)),n},this.insert=function(t){var n,o,l=function e(n,o){if(null===n)return o;var l=i[n.dimension];return t[l]<n.obj[l]?e(n.left,n):e(n.right,n)}(this.root,null);if(null===l){this.root=new e(t,0,null);return}n=new e(t,(l.dimension+1)%i.length,l),t[o=i[l.dimension]]<l.obj[o]?l.left=n:l.right=n},this.remove=function(t){var e;null!==(e=function e(n){if(null===n)return null;if(n.obj===t)return n;var o=i[n.dimension];return t[o]<n.obj[o]?e(n.left,n):e(n.right,n)}(l.root))&&function t(e){var n,o,r;function a(t,e){var n,o,l,r,c;return null===t?null:(n=i[e],t.dimension===e)?null!==t.left?a(t.left,e):t:(o=t.obj[n],l=a(t.left,e),r=a(t.right,e),c=t,null!==l&&l.obj[n]<o&&(c=l),null!==r&&r.obj[n]<c.obj[n]&&(c=r),c)}if(null===e.left&&null===e.right){if(null===e.parent){l.root=null;return}r=i[e.parent.dimension],e.obj[r]<e.parent.obj[r]?e.parent.left=null:e.parent.right=null;return}null!==e.right?(o=(n=a(e.right,e.dimension)).obj,t(n)):(o=(n=a(e.left,e.dimension)).obj,t(n),e.right=e.left,e.left=null),e.obj=o}(e)},this.nearest=function(t,e,r){var a,c,u;if(u=new n(function(t){return-t[1]}),r)for(a=0;a<e;a+=1)u.push([null,r]);for(l.root&&function n(l){var r,a,c,d,s=i[l.dimension],h=o(t,l.obj),f={};function p(t,n){u.push([t,n]),u.size()>e&&u.pop()}for(d=0;d<i.length;d+=1)d===l.dimension?f[i[d]]=t[i[d]]:f[i[d]]=l.obj[i[d]];if(a=o(f,l.obj),null===l.right&&null===l.left){(u.size()<e||h<u.peek()[1])&&p(l,h);return}n(r=null===l.right?l.left:null===l.left?l.right:t[s]<l.obj[s]?l.left:l.right),(u.size()<e||h<u.peek()[1])&&p(l,h),(u.size()<e||Math.abs(a)<u.peek()[1])&&null!==(c=r===l.left?l.right:l.left)&&n(c)}(l.root),c=[],a=0;a<Math.min(e,u.content.length);a+=1)u.content[a][0]&&c.push([u.content[a][0].obj,u.content[a][1]]);return c},this.balanceFactor=function(){return function t(e){return null===e?0:Math.max(t(e.left),t(e.right))+1}(l.root)/(Math.log(function t(e){return null===e?0:t(e.left)+t(e.right)+1}(l.root))/Math.log(2))}},t.BinaryHeap=n},"function"==typeof define&&define.amd?define(["exports"],e):e(n);let o=null,i=null,l=null,r=null,a=0,c=0;function u(t,e){if(r&&a===t&&c===e)return r;console.log(`Creating new projection for ${t}x${e}`);let n=d3.geoMercator().scale(t/(2*Math.PI)).translate([t/2,e/2]),o={pixelToGeo:function(t,e){let[o,i]=n.invert([t,e]);return{latitude:i,longitude:o}},geoToPixel:function(t,e){let[o,i]=n([e,t]);return{x:o,y:i}}};return r=o,a=t,c=e,o}function d(){let t,e;o||(o=document.querySelector("#world-map")),i||(i=document.querySelector(".scale-bar")),l||(l=document.querySelector(".scale-text"));let n=o,r=i,a=l;if(!n||!r||!a)return;let c=n.getBoundingClientRect(),d=c.width,s=c.height,h=u(d,s),f=function(t,e,n,o,i){let l=i.pixelToGeo(n/2-50,e),r=i.pixelToGeo(n/2+50,e);return!l||!r||isNaN(l.latitude)||isNaN(r.latitude)?(console.warn("Scale bar position is off the projected map."),0):6371e3*d3.geoDistance([l.longitude,l.latitude],[r.longitude,r.latitude])}(100,.95*s,d,0,h);if(0===f){a.textContent="",r.style.width="0px";return}r.style.width="100px",f>=1e3?(t=Math.round(f/1e3),e="km"):(t=10*Math.round(f/10),e="m"),a.textContent=`${t} ${e}`}window.addEventListener("resize",()=>{clearTimeout(t),t=setTimeout(d,100)}),document.addEventListener("DOMContentLoaded",()=>{o=document.querySelector("#world-map"),i=document.querySelector(".scale-bar"),l=document.querySelector(".scale-text"),d()}),document.addEventListener("click",t=>{let e=o||document.querySelector("#world-map");if(!e)return;let n=e.getBoundingClientRect(),i=t.clientX-n.left,l=t.clientY-n.top,r=u(n.width,n.height).pixelToGeo(i,l);r&&!isNaN(r.latitude)?console.log(`click -> (${r.latitude.toFixed(3)}, ${r.longitude.toFixed(3)})`):console.log("Clicked outside projected area.")});let s=[],h=null,f=null;const p=Math.PI/180;function g(t,e){for(let n=0;n<t;n++)e.push({location:{latitude:180*Math.random()-90,longitude:360*Math.random()-180},current:{temperature2m:0,windSpeed10m:0,windDirection10m:0},computed:{opacity:.5,color:"rgba(255, 255, 255, 0.5)",tail:[]}})}async function m(t){try{let e=await fetch(t);if(!e.ok)return console.error(`Error fetching weather data file ${t}: ${e.status} ${e.statusText}`),null;let n=await e.json();if(!n||!n.data)return console.error(`Invalid data structure in ${t}. Expected { timestamp: number, data: WeatherData[] }`),null;let o=n.data;return console.log(`Successfully loaded ${o.length} weather data points from ${t}.`),o}catch(e){return console.error(`Error loading or parsing weather data file ${t}:`,e),null}}let w=[],M=null,y=null,b=null,x=null;function v(){if(!M||!y)return;let t=document.querySelector("#world-map");if(!t)return;let e=t.getBoundingClientRect();M.width=e.width,M.height=e.height,y.clearRect(0,0,M.width,M.height);let n=u(M.width,M.height);w.forEach(t=>{let{location:e,current:o,computed:i}=t,l=n.geoToPixel(e.latitude,e.longitude);!function(t,e,n,o,i,l){let r=o*Math.PI/180;t.save(),t.translate(e,n),t.rotate(r),t.globalAlpha=i,t.strokeStyle=l,t.lineWidth=1,t.beginPath(),t.moveTo(-4,-4),t.lineTo(0,0),t.lineTo(-4,4),t.stroke(),t.restore()}(y,l.x,l.y,o.windDirection10m,parseFloat(i.opacity),i.color)}),d()}window.addEventListener("resize",function(){clearTimeout(window.resizeTimer),window.resizeTimer=setTimeout(function(){v(),j()},200)}),document.addEventListener("DOMContentLoaded",async function(){if(!(M=document.getElementById("arrow-canvas"))){console.error("Canvas element not found!");return}if(!(y=M.getContext("2d"))){console.error("Could not get 2D context from canvas!");return}!function(){if(!(h=document.getElementById("wind-canvas"))){console.error("Wind canvas element not found!");return}if(!(f=h.getContext("2d"))){console.error("Could not get 2D context from wind canvas!");return}g(1e4,s),console.log("Wind layer initialized with",s.length,"particles")}();let t="/map/assets/weather_data_cache.json",e=await m(t);if(e)(w=e).forEach(t=>{if(!t.location){console.warn("Skipping data point with missing location:",t);return}let e=t.location.latitude*Math.PI/180,n=t.location.longitude*Math.PI/180;t.x=+Math.cos(e)*Math.cos(n),t.y=+Math.cos(e)*Math.sin(n),t.z=+Math.sin(e)}),(b=0!==w.length&&w[0].hasOwnProperty("x")?(console.log("Building KDTree with geographic distance metric and data:",w),console.log("KDTree built with data:",b=new(0,n.kdTree)(w,function(t,e){let n=t?.location?.latitude,o=t?.location?.longitude,i=e?.location?.latitude,l=e?.location?.longitude,r=n*Math.PI/180,a=o*Math.PI/180,c=i*Math.PI/180,u=l*Math.PI/180,d=Math.cos(r)*Math.cos(a)-Math.cos(c)*Math.cos(u),s=Math.cos(r)*Math.sin(a)-Math.cos(c)*Math.sin(u),h=Math.sin(r)-Math.sin(c);return Math.sqrt(d*d+s*s+h*h)},["x","y","z"])),b):(console.log("Cannot build weather data tree: no data points available or missing x,y,z coords."),null))?(console.log("KDTree built successfully from static file."),v(),T=Date.now(),function t(){let e=Date.now(),n=e-T;n>=33.333333333333336&&(!function(t){if(!h||!f){console.warn("Wind canvas or context not initialized, skipping redraw.");return}if(!b){window.hasLoggedMissingTree||(console.warn("Weather data tree not available, skipping wind particle redraw."),window.hasLoggedMissingTree=!0),f.clearRect(0,0,h.width,h.height);return}let e=document.querySelector("#world-map");if(!e)return;let n=e.getBoundingClientRect();(h.width!==n.width||h.height!==n.height)&&(h.width=n.width,h.height=n.height),f.clearRect(0,0,h.width,h.height);let o=u(h.width,h.height),i=15*t,l=Math.floor(.02*s.length);l>0&&(s.splice(0,l),g(l,s)),s.forEach(t=>{let e=t.location.latitude*p,n=t.location.longitude*p;t.x=+Math.cos(e)*Math.cos(n),t.y=+Math.cos(e)*Math.sin(n),t.z=+Math.sin(e);let l=b.nearest(t,1);if(!l||0===l.length)return;let[r,a]=l[0];t.current.windSpeed10m+=(r.current.windSpeed10m-t.current.windSpeed10m)*.05;let c=r.current.windDirection10m-t.current.windDirection10m;for(;c<=-180;)c+=360;for(;c>180;)c-=360;t.current.windDirection10m+=.05*c,t.current.windDirection10m=(t.current.windDirection10m+360)%360,t.computed.color=r.computed.color,t.computed.opacity=parseFloat(r.computed.opacity);let u=t.current.windSpeed10m/111e3*i,d=t.current.windDirection10m*p,s=-(u*Math.cos(d)),h=u*Math.sin(d),g=Math.cos(e),m=g>.01?h/g:0,w=t.computed.pixelX,M=t.computed.pixelY;t.location.latitude+=s,t.location.longitude+=m;let y=!1;t.location.latitude>90?(t.location.latitude=180-t.location.latitude,t.location.longitude+=180,y=!0):t.location.latitude<-90&&(t.location.latitude=-180-t.location.latitude,t.location.longitude+=180,y=!0),t.location.longitude>180?(t.location.longitude-=360,y=!0):t.location.longitude<-180&&(t.location.longitude+=360,y=!0);let x=o.geoToPixel(t.location.latitude,t.location.longitude);if(t.computed.pixelX=x.x,t.computed.pixelY=x.y,y?t.computed.tail=[]:(t.computed.tail.push({latitude:t.location.latitude-s,longitude:t.location.longitude-m}),t.computed.tail.length>10&&t.computed.tail.shift()),t.computed.tail.length>1&&!y&&void 0!==w&&void 0!==M){f.beginPath(),f.moveTo(w,M),f.lineTo(t.computed.pixelX,t.computed.pixelY);for(let e=t.computed.tail.length-2;e>=0;e--){let n=o.geoToPixel(t.computed.tail[e].latitude,t.computed.tail[e].longitude);f.lineTo(n.x,n.y)}f.strokeStyle=t.computed.color,f.globalAlpha=.3,f.lineWidth=1,f.stroke()}!function(t,e,n,o,i){t.fillStyle=i,t.globalAlpha=o;let l=Math.min(window.innerWidth,window.innerHeight),r=1;l>=768?r=3:l>=480&&(r=2);let a=r/2;t.fillRect(Math.floor(e-a),Math.floor(n-a),r,r)}(f,t.computed.pixelX,t.computed.pixelY,t.computed.opacity,t.computed.color)})}(n),T=e),requestAnimationFrame(t)}()):console.error("Failed to build KDTree from static file data.");else{console.error(`Failed to load weather data from ${t}. Cannot initialize map features.`);let e=document.getElementById("world-map");e&&(e.innerHTML='<p style="color: red; text-align: center; margin-top: 50px;">Error: Could not load essential weather data.</p>');return}x=u(M.width,M.height),j()});let T=0;function j(){let t=document.getElementById("world-map"),e=document.getElementById("tooltip");if(!t||!e||!x){console.error("Map, tooltip, or coordinate converter not available for tooltip setup.");return}t.addEventListener("mousemove",t=>{if(!b)return;let n=t.target.getBoundingClientRect(),o=t.clientX-n.left,i=t.clientY-n.top,l=x.pixelToGeo(o,i);if(!l){e.style.display="none";return}let{latitude:r,longitude:a}=l,c=r*Math.PI/180,u=a*Math.PI/180,d=b.nearest({x:+Math.cos(c)*Math.cos(u),y:+Math.cos(c)*Math.sin(u),z:+Math.sin(c),location:{latitude:r,longitude:a},current:{temperature2m:0,windSpeed10m:0,windDirection10m:0},computed:{opacity:"0",color:""}},1);if(d&&d.length>0){let[n,o]=d[0],i=n.current.temperature2m.toFixed(1),l=n.current.windSpeed10m.toFixed(1);e.innerHTML=`Temp: ${i}\xb0C
Wind: ${l} m/s`,e.style.left=`${t.pageX+15}px`,e.style.top=`${t.pageY+10}px`,e.style.display="block"}else e.style.display="none"}),t.addEventListener("mouseout",()=>{e.style.display="none"}),console.log("Tooltip interactions initialized.")}
//# sourceMappingURL=map.3c69c090.js.map
